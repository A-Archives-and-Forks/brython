<!doctype html>
<html>
<head>
<meta name="description" content="Brython">
<meta name="keywords" content="Python,Brython">
<meta name="author" content="Dan Stromberg, Pierre Quentel">
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">

<script type="text/javascript" src="/src/brython_builtins.js"></script>

<script type="text/javascript" src="/src/py_ast_classes.js"></script>
<script type="text/javascript" src="/src/stdlib_paths.js"></script>
<script type="text/javascript" src="/src/unicode_data.js"></script>
<script type="text/javascript" src="/src/version_info.js"></script>

<script type="text/javascript" src="/src/python_tokenizer.js"></script>
<script type="text/javascript" src="/src/py_ast.js"></script>
<script type="text/javascript" src="/src/py2js.js"></script>
<script type="text/javascript" src="/src/loaders.js"></script>
<script type="text/javascript" src="/src/py_utils.js"></script>
<script type="text/javascript" src="/src/py_object.js"></script>
<script type="text/javascript" src="/src/py_type.js"></script>
<script type="text/javascript" src="/src/py_builtin_functions.js"></script>
<script type="text/javascript" src="/src/py_sort.js"></script>
<script type="text/javascript" src="/src/py_exceptions.js"></script>
<script type="text/javascript" src="/src/py_range_slice.js"></script>
<script type="text/javascript" src="/src/py_bytes.js"></script>
<script type="text/javascript" src="/src/py_set.js"></script>
<script type="text/javascript" src="/src/js_objects.js"></script>
<script type="text/javascript" src="/src/py_import.js"></script>
<script type="text/javascript" src="/src/py_string.js"></script>
<script type="text/javascript" src="/src/py_int.js"></script>
<script type="text/javascript" src="/src/py_long_int.js"></script>
<script type="text/javascript" src="/src/py_float.js"></script>
<script type="text/javascript" src="/src/py_complex.js"></script>
<script type="text/javascript" src="/src/py_dict.js"></script>
<script type="text/javascript" src="/src/py_list.js"></script>
<script type="text/javascript" src="/src/py_generator.js"></script>
<script type="text/javascript" src="/src/py_dom.js"></script>
<script type="text/javascript" src="/src/py_pattern_matching.js"></script>
<script type="text/javascript" src="/src/async.js"></script>
<script type="text/javascript" src="/src/py_flags.js"></script>
<script type="text/javascript" src="/src/builtin_modules.js"></script>
<script type="text/javascript" src="/src/ast_to_js.js"></script>
<script type="text/javascript" src="/src/symtable.js"></script>

<!-- script type="text/python" src="show_source.py"></script -->

<style>
.plugin {
    width: 20px;
    background-color: #fff;
    border-width: 2px;
    border-radius: 10px;
    border-color: #000;
}

.plugout {
    width: 20px;
    background-color: #fff;
    border-width: 2px;
    border-radius: 10px;
    border-color: #000;
}

.controlValue {
    width: 2em;
    font-size: 0.5em;
}

input[type=range] {
  height: 1em;
  -webkit-appearance: none;
  margin: 0.2em 0;
  width: 6em;
}
input[type=range]:focus {
  outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 5em;
  height: 1em;
  cursor: pointer;
  animate: 0.2s;
  box-shadow: 0px 0px 0px #000000;
  background: #B6B6B6;
  border: 1px solid #8A8A8A;
}
input[type=range]::-webkit-slider-thumb {
  box-shadow: 1px 1px 1px #828282;
  border: 1px solid #8A8A8A;
  height: 0.9em;
  width: 1em;
  background: #DADADA;
  cursor: pointer;
  -webkit-appearance: none;
}
input[type=range]:focus::-webkit-slider-runnable-track {
  background: #B6B6B6;
}
input[type=range]::-moz-range-track {
  width: 5em;
  height: 1em;
  cursor: pointer;
  animate: 0.2s;
  box-shadow: 0px 0px 0px #000000;
  background: #B6B6B6;
  border: 1px solid #8A8A8A;
}
input[type=range]::-moz-range-thumb {
  box-shadow: 1px 1px 1px #828282;
  border: 1px solid #8A8A8A;
  height: 0.9em;
  width: 1em;
  background: #DADADA;
  cursor: pointer;
}
input[type=range]::-ms-track {
  width: 100%;
  height: 16px;
  cursor: pointer;
  animate: 0.2s;
  background: transparent;
  border-color: transparent;
  color: transparent;
}
input[type=range]::-ms-fill-lower {
  background: #B6B6B6;
  border: 1px solid #8A8A8A;
  border-radius: 50px;
  box-shadow: 0px 0px 0px #000000;
}
input[type=range]::-ms-fill-upper {
  background: #B6B6B6;
  border: 1px solid #8A8A8A;
  border-radius: 50px;
  box-shadow: 0px 0px 0px #000000;
}
input[type=range]::-ms-thumb {
  margin-top: 1px;
  box-shadow: 1px 1px 1px #828282;
  border: 1px solid #8A8A8A;
  height: 24px;
  width: 35px;
  border-radius: 6px;
  background: #DADADA;
  cursor: pointer;
}
input[type=range]:focus::-ms-fill-lower {
  background: #B6B6B6;
}
input[type=range]:focus::-ms-fill-upper {
  background: #B6B6B6;
}

.control-legend {
  display: inline-block;
  width: 5em;
  font-size: 0.7em;
  color: blue;
  text-align: center;
}

.control-show {
  display: inline-block;
  width: 1em;
  color: blue;
}

</style>

<title>Brython synth keyboard</title>

</head>
<body onload="brython(2)">

<script type="text/python">
import random
import math

from browser import document, window, html, console, bind, timer, alert, svg
from browser.widgets import dialog

import music

scale = music.create_major_scale('C')

audioContext = None
playground = document['playground']
playground.width = window.innerWidth
playground.height = window.innerHeight - 100

def search_gains(widget, t=None):
    # return a list of the gain nodes connected to the widget
    if t is None:
        t = []
    if widget not in t:
        if widget.type == 'gain':
            t.append(widget)
        for plugout in widget.select('.plugout'):
            if plugout.connected:
                search_gains(plugout.destination.widget, t)
    return t

def create_oscillator(freq, detune=0):
    osc = window.OscillatorNode.new(audioContext)
    osc.frequency.value = freq
    osc.detune.value = detune
    return osc

def start_play_panel(panel, freq=None):
    if freq is None:
        freq = float(panel.select_one('INPUT').value)

    width = float(panel.width_control.value)
    freqs = [freq]

    osc_list = [create_oscillator(freq)]
    if width:
        osc_list.append(create_oscillator(freq, width))
        osc_list.append(create_oscillator(freq, -width))

    for osc in osc_list:
        osc.type = panel.select_one('#wave').value
        for plugout in panel.select('.plugout'):
            if plugout.connected:
                osc.connect(plugout.destination.widget.audio_node)

    t0 = audioContext.currentTime
    gains = search_gains(panel)
    for gain_widget in gains:
        attack = float(gain_widget.attack_control.value)
        gain = gain_widget.audio_node.gain
        v = gain.value = float(gain_widget.gain_control.value)
        gain.cancelScheduledValues(t0)
        gain.setValueAtTime(0, t0)
        gain.linearRampToValueAtTime(v, t0 + attack)

    for osc in osc_list:
        osc.start(t0)

    return [osc_list, gains]

def stop_play(ev):
    stop_play_panel(ev.target.closest('DIV'))

def stop_play_panel(panel):
    t0 = audioContext.currentTime
    release = 0.05
    for gain_widget in search_gains(panel):
        release = float(gain_widget.release_control.value)
        gain = gain_widget.audio_node.gain
        gain.linearRampToValueAtTime(0, t0 + release)
    panel.osc.stop(t0 + release + 0.1)

def stop_oscillator(osc, gains):
    t0 = audioContext.currentTime
    release = 0.05
    for gain_widget in gains:
        release = float(gain_widget.release_control.value)
        gain = gain_widget.audio_node.gain
        gain.linearRampToValueAtTime(0, t0 + release)
    osc.stop(t0 + release + 0.1)

def start_play_note(freq):
    playing[freq] = []
    for panel in oscillators:
        playing[freq].append(start_play_panel(panel, freq))

def stop_play_note(freq):
    for panel, (osc_list, gains) in zip(oscillators, playing[freq]):
        for osc in osc_list:
            stop_oscillator(osc, gains)
    del playing[freq]

buttons = document["buttons"]
scale = music.create_major_scale('C', 4)[:8]
for (octave, name) in scale:
    freq = music.note_freqs[octave][name]
    mousedown = lambda ev, freq=freq: start_play_note(freq)
    mouseup = lambda ev, freq=freq: stop_play_note(freq)
    button = html.BUTTON(name, onmousedown=mousedown, onmouseup=mouseup)
    buttons <= button

playing = {}

@bind(document, 'keydown')
def keydown(ev):
    if ev.key in '12345678':
        octave, name = scale[int(ev.key) - 1]
        freq = music.note_freqs[octave][name]
        if freq not in playing:
            start_play_note(freq)

@bind(document, 'keyup')
def keyup(ev):
    if ev.key in '12345678':
        octave, name = scale[int(ev.key) - 1]
        freq = music.note_freqs[octave][name]
        stop_play_note(freq)


dx = 0
dy = 50

line = None

def connect(plugout, plugin):
    plugin.connected = True
    plugin.origin = plugout
    plugin.line = line
    plugin.style.backgroundColor = '#000'
    plugout.connected = True
    plugout.destination = plugin
    plugout.line = line
    plugout.style.backgroundColor = '#000'

    if plugin.widget.audio_node and plugout.widget.audio_node:
        plugout.widget.audio_node.connect(plugin.widget.audio_node)

def disconnect(plugout, plugin):
    plugin.connected = False
    del plugin.origin
    plugin.line.remove()
    plugin.style.backgroundColor = '#fff'
    del plugin.line
    plugout.connected = False
    plugout.style.backgroundColor = '#fff'
    del plugout.destination
    del plugout.line
    if plugin.widget.audio_node and plugout.widget.audio_node:
        plugout.widget.audio_node.disconnect(plugin.widget.audio_node)

class PlugOut(html.BUTTON):

    def __init__(self, widget, *args, **kw):
        html.BUTTON.__init__(self, *args, **kw)
        self.widget = widget
        self.connected = False
        self.style.display = 'block'
        self.bind('mousedown', self.click_plug)

    def click_plug(self, ev):
        if self.connected:
            # disconnect
            disconnect(self, self.destination)
            return
        global line
        self.mouse_pos = [ev.x, ev.y]
        line = svg.line(x1=ev.x + dx,
                         y1=ev.y - dy,
                         x2=ev.x + dx,
                         y2=ev.y - dy,
                         stroke='#000',
                         stroke_width=2)
        line.origin = self
        playground <= line
        document.bind('mousemove', self.draw_cable)
        document.bind('mouseup', self.plug)

    def draw_cable(self, ev):
        line.attrs['x2'] = ev.x + dx
        line.attrs['y2'] = ev.y - dy

    def plug(self, ev):
        global line
        if not self.connected:
            line.remove()
        line = None
        document.unbind('mousemove')
        document.unbind('mouseup')

class PlugIn(html.BUTTON):

    def __init__(self, widget, *args, **kw):
        html.BUTTON.__init__(self, *args, **kw)
        self.widget = widget
        self.connected = False
        self.style.display = 'block'
        self.bind('mouseup', self.mouseup)

    def mouseup(self, ev):
        if self.connected:
            return
        if line is not None:
            connect(line.origin, self)

oscillators = []
shapes = "sine", "sawtooth", "triangle", "square"

@bind('#oscillator', 'click')
def add_oscillator(ev):
    init_context()
    widget = Widget('oscillator')
    widget.add_plugins(4)
    widget.add_plugouts(4)

    widget.audio_node = None
    d = dialog.Dialog('Oscillator', left=100, top=100)
    d.panel.type = 'oscillator'
    d.panel <= widget

    waveform_control = html.SELECT(html.OPTION(w) for w in shapes)
    waveform_control.id = 'wave'
    widget.middle <= html.DIV('Waveform' + waveform_control)
    widget.middle.style.verticalAlign = 'middle'

    widget.width_control = Control('Width', 0, 50, 1, 0)
    widget.middle <= widget.width_control

    oscillators.append(widget)

@bind(document, 'dialog_down')
def dialog_down(ev):
    for plugin in ev.dialog.select('.plugin'):
        if plugin.connected:
            plugin.x2_start = int(plugin.line.attrs['x2'])
            plugin.y2_start = int(plugin.line.attrs['y2'])
    for plugout in ev.dialog.select('.plugout'):
        if plugout.connected:
            plugout.x1_start = int(plugout.line.attrs['x1'])
            plugout.y1_start = int(plugout.line.attrs['y1'])

@bind(document, 'dialog_move')
def dialog_move(ev):
    for plugin in ev.dialog.select('.plugin'):
        if plugin.connected:
            plugin.line.attrs['x2'] = plugin.x2_start + ev.dx
            plugin.line.attrs['y2'] = plugin.y2_start + ev.dy
    for plugout in ev.dialog.select('.plugout'):
        if plugout.connected:
            plugout.line.attrs['x1'] = plugout.x1_start + ev.dx
            plugout.line.attrs['y1'] = plugout.y1_start + ev.dy

@bind(document, 'dialog_close')
def dialog_close(ev):
    for plugin in ev.dialog.select('.plugin'):
        if plugin.connected:
            disconnect(plugin.origin, plugin)
    for plugout in ev.dialog.select('.plugout'):
        if plugout.connected:
            disconnect(plugout, plugout.destination)

class Control(html.DIV):

    def __init__(self, legend, min_value, max_value, step, value, variable=None):
        html.DIV.__init__(self)

        self.control = html.INPUT(type='range', min=min_value, max=max_value,
                                  step=step,
                                  value=value)
        control_show = html.SPAN(self.control.value, Class='controlValue')
        if variable is not None:
            setattr(variable, "value", self.control.value)

        @bind(self.control, 'change')
        def change(ev):
            control_show.text = self.control.value
            if variable is not None:
                if hasattr(variable, 'setValueAtTime'):
                    variable.setValueAtTime(self.control.value,
                      audioContext.currentTime)
                else:
                    setattr(variable, "value", self.control.value)

        self <= (html.SPAN(legend, Class='control-legend') +
                 self.control +
                 html.SPAN(control_show, Class='control-show'))

    @property
    def value(self):
        return self.control.value


@bind('#gain', 'click')
def add_gain(ev):
    init_context()
    widget = Widget('gain')
    widget.add_plugins(4)
    widget.add_plugouts(4)
    d = dialog.Dialog('GainNode')
    d.panel <= widget
    d.panel.type = 'gain'

    widget.audio_node = window.GainNode.new(audioContext)

    widget.gain_control = Control('Volume', 0, 1, 0.01, 0.5,
                                  variable=widget.audio_node.gain)
    widget.attack_control = Control('Attack', 0, 1, 0.01, 0.2)
    widget.release_control = Control('Release', 0, 1, 0.01, 0.2)

    widget.middle <= (widget.gain_control +
                      widget.attack_control +
                      widget.release_control)


@bind('#filter', 'click')
def add_filter(ev):
    init_context()
    widget = Widget('filter')
    widget.add_plugins(4)
    widget.add_plugouts(4)
    d = dialog.Dialog('FilterNode')
    d.panel <= widget
    d.panel.type = 'filter'

    widget.audio_node = window.BiquadFilterNode.new(audioContext)
    widget.audio_node.type = 'lowpass'

    max_filter_freq = 1000
    widget.frequency_control = Control('Frequency', 0, max_filter_freq, 1, 440,
                                       variable=widget.audio_node.frequency)
    widget.q_control = Control('Q', 0, 50, 1, 25,
                               variable=widget.audio_node.Q)

    widget.middle <= widget.frequency_control + widget.q_control


@bind('#delay', 'click')
def add_delay(ev):
    init_context()
    widget = Widget('delay')
    widget.add_plugins(4)
    widget.add_plugouts(4)
    d = dialog.Dialog('DelayNode')
    d.panel <= widget
    d.panel.type = 'filter'

    widget.audio_node = window.DelayNode.new(audioContext)

    widget.delayTime_control = Control('Delay time', 0, 1, 0.01, 0.2,
                                       variable=widget.audio_node.delayTime)

    widget.middle <= widget.delayTime_control

@bind('#delay_feedback', 'click')
def add_delay_feedback(ev):
    init_context()
    widget = Widget('delay')
    widget.add_plugins(4)
    widget.add_plugouts(4)
    d = dialog.Dialog('DelayFeedbackNode')
    d.panel <= widget
    d.panel.type = 'delay_feedback'

    widget.audio_node = window.DelayNode.new(audioContext)
    feedback = window.GainNode.new(audioContext)

    widget.delayTime_control = Control('Delay time', 0, 1, 0.01, 0.2,
                                       variable=widget.audio_node.delayTime)

    feedback_control = Control('Feedback', 0, 1, 0.01, 0.2,
                                       variable=feedback.gain)

    widget.audio_node.connect(feedback)
    feedback.connect(widget.audio_node)

    widget.middle <= widget.delayTime_control + feedback_control



class Widget(html.TABLE):

    def __init__(self, _type):
        super().__init__()
        self.type = _type
        self.plugins = html.TD()
        self.middle = html.TD()
        self.plugouts = html.TD()
        self <= html.TR(self.plugins + self.middle + self.plugouts)

    def add_plugins(self, nb=4):
        for i in range(4):
            self.plugins <= PlugIn(self, '&nbsp;', Class='plugin')

    def add_plugouts(self, nb=4):
        for i in range(4):
            self.plugouts <= PlugOut(self, '&nbsp;', Class='plugout')

def init_context():
    global audioContext
    if audioContext is None:
        audioContext = window.AudioContext.new()
        w.audio_node = audioContext.destination

@bind('#play_all', 'mousedown')
def play_all(ev):
    for osc in oscillators:
        start_play_panel(osc)

@bind('#play_all', 'mouseup')
def play_all(ev):
    for osc in oscillators:
        stop_play_panel(osc)


w = Widget('destination')
w.add_plugins(4)
destination = dialog.Dialog('Destination',
                            can_close=False,
                            left=8 * window.innerWidth // 10)
destination.panel <= w
destination.panel.type = None


</script>

<div id="buttons">
<button id="oscillator">add oscillator</button>
<button id="gain">add gain</button>
<button id="filter">add filter</button>
<button id="delay">add delay</button>
<button id="delay_feedback">add delay + feedback</button>
<button id="play_all">play all</button>
</div>

<div id="zone">
  <svg id="playground" width=800 height=600 style="position:absolute;left:10px;top:50px;background-color:#eee"></svg>
</div>
</body>
</html>


